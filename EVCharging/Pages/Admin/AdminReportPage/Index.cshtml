@page
@model EVCharging.Pages.Admin.AdminReportPage.IndexModel
@{
    Layout = "_AdminLayout";
}


<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-info">
            <i class="fa-solid fa-chart-line me-2"></i>Thống kê & Báo cáo doanh thu
        </h3>

        <form method="get" class="d-flex align-items-center">
            <label class="me-2 text-light fw-semibold">Chọn năm:</label>
            <select name="Year" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                @{
                    var currentYear = DateTime.Now.Year;
                    for (int y = currentYear; y >= currentYear - 5; y--)
                    {
                        <option value="@y" selected="@(y == Model.Year ? "selected" : null)">@y</option>
                    }
                }
            </select>
        </form>
    </div>

    <!-- === Cards tổng quan === -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-center p-3">
                <h6 class="card-title">Doanh thu tháng này</h6>
                <h4 class="text-success fw-bold">
                    @(Model.Dashboard?.TotalRevenueThisMonth.ToString("N0") ?? "0") đ
                </h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center p-3">
                <h6 class="card-title">Doanh thu năm @Model.Year</h6>
                <h4 class="text-info fw-bold">
                    @(Model.Dashboard?.TotalRevenueThisYear.ToString("N0") ?? "0") đ
                </h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center p-3">
                <h6 class="card-title">Trạng thái Giao dịch</h6>
                <h4 class="fw-bold text-warning">
                    @(Model.Dashboard?.TransactionStatusCounts?.Count ?? 0)
                </h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center p-3">
                <h6 class="card-title">Số trạm sạc top doanh thu</h6>
                <h4 class="fw-bold text-primary">
                    @(Model.Dashboard?.TopStations?.Count ?? 0)
                </h4>
            </div>
        </div>
    </div>

    <!-- === Biểu đồ Doanh thu theo tháng === -->
    <div class="card p-4 mb-4">
        <h5 class="card-title">
            <i class="fa-solid fa-chart-column me-2 text-info"></i>
            Doanh thu theo tháng (@Model.Year)
        </h5>
        <canvas id="monthlyRevenueChart" height="100"></canvas>
    </div>

    <!-- === Hàng 2: Biểu đồ trạng thái & doanh thu năm === -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card p-4 d-flex align-items-center justify-content-center">
                <h5 class="card-title w-100 text-center mb-3">
                    <i class="fa-solid fa-pie-chart me-2 text-info"></i>
                    Tỷ lệ trạng thái giao dịch
                </h5>
                <div style="max-width:300px; max-height:300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-4">
                <h5 class="card-title">
                    <i class="fa-solid fa-chart-bar me-2 text-info"></i>
                    Doanh thu theo năm
                </h5>
                <canvas id="yearlyRevenueChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- === Top 5 Trạm sạc === -->
    <div class="card p-4 mb-4">
        <h5 class="card-title">
            <i class="fa-solid fa-tower-broadcast me-2 text-info"></i>
            Top 5 Trạm sạc doanh thu cao nhất
        </h5>
        <canvas id="topStationChart" height="100"></canvas>
    </div>

    <!-- === Top 5 Người dùng === -->
    <div class="card p-4 mb-4">
        <h5 class="card-title">
            <i class="fa-solid fa-users me-2 text-info"></i>
            Top 5 Người dùng chi tiêu nhiều nhất
        </h5>
        <canvas id="topUserChart" height="100"></canvas>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==== Dữ liệu từ C# sang JS ====
        let monthlyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Dashboard.MonthlyRevenues ?? new()));
        let yearlyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Dashboard.YearlyRevenues ?? new()));
        let statusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Dashboard.TransactionStatusCounts ?? new()));
        let topStations = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Dashboard.TopStations ?? new()));
        let topUsers = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Dashboard.TopUsers ?? new()));

        // === Lọc bỏ "Không xác định" trong trạm sạc ===
        topStations = topStations.filter(x => x.StationName && x.StationName !== "Không xác định");

        // === Biểu đồ Doanh thu theo tháng ===
        new Chart(document.getElementById("monthlyRevenueChart"), {
            type: "line",
            data: {
                labels: monthlyData.map(x => "T" + x.Month),
                datasets: [{
                    label: "Doanh thu (VNĐ)",
                    data: monthlyData.map(x => x.Revenue),
                    borderColor: "#38bdf8",
                    backgroundColor: "rgba(56,189,248,0.2)",
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        // === Biểu đồ Doanh thu theo năm ===
        new Chart(document.getElementById("yearlyRevenueChart"), {
            type: "bar",
            data: {
                labels: yearlyData.map(x => x.Year),
                datasets: [{
                    label: "Doanh thu (VNĐ)",
                    data: yearlyData.map(x => x.Revenue),
                    backgroundColor: "#34d399"
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // === Biểu đồ trạng thái giao dịch (nhỏ gọn, giữa khung) ===
        new Chart(document.getElementById("statusChart"), {
            type: "pie",
            data: {
                labels: statusData.map(x => x.Status),
                datasets: [{
                    data: statusData.map(x => x.Count),
                    backgroundColor: ["#38bdf8", "#facc15", "#ef4444", "#22c55e"]
                }]
            },
            options: {
                plugins: {
                    legend: { position: "bottom", labels: { color: "#f1f5f9" } }
                }
            }
        });

        // === Top 5 trạm sạc ===
        new Chart(document.getElementById("topStationChart"), {
            type: "bar",
            data: {
                labels: topStations.map(x => x.StationName),
                datasets: [{
                    label: "Doanh thu (VNĐ)",
                    data: topStations.map(x => x.Revenue),
                    backgroundColor: "#818cf8"
                }]
            },
            options: {
                indexAxis: "y",
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });

        // === Top 5 người dùng ===
        new Chart(document.getElementById("topUserChart"), {
            type: "bar",
            data: {
                labels: topUsers.map(x => x.UserName),
                datasets: [{
                    label: "Tổng chi tiêu (VNĐ)",
                    data: topUsers.map(x => x.TotalSpent),
                    backgroundColor: "#f472b6"
                }]
            },
            options: {
                indexAxis: "y",
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    </script>
}