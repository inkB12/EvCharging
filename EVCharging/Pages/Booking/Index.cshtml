@page
@model EVCharging.Pages.Bookings.IndexModel
@{
    ViewData["Title"] = "Lịch đặt của tôi";
    // Tự động dùng _Layout.cshtml (header sáng)
    var nowUtc = DateTime.UtcNow;
}

<!-- XÓA: Link Bootstrap (đã có trong Layout) -->
<!-- XÓA: Khối <style> (đã chuyển vào site.css) -->
<!-- Bọc nội dung trong .container-narrow (class của _Layout.cshtml) -->
<div class="container container-narrow my-4">

    <!-- TIÊU ĐỀ VÀ THÔNG BÁO -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5 fw-bold mb-0">Lịch sử Đặt sạc</h1>
        <div>
            @if (TempData["Info"] is string info)
            {
                <div class="alert alert-success py-2 px-3 mb-0 shadow-sm border-0">@info</div>
            }
            @if (TempData["Error"] is string err)
            {
                <div class="alert alert-danger py-2 px-3 mb-0 shadow-sm border-0">@err</div>
            }
        </div>
    </div>

    <!-- KHUNG LỌC (FILTER) - THIẾT KẾ LẠI -->
    <div class="card shadow-sm mb-4" style="border-radius: 0.75rem;">
        <div class="card-header bg-white border-0 py-3">
            <h5 class="mb-0">
                <i class="bi bi-filter me-2 text-primary"></i>
                Lọc lịch sử
            </h5>
        </div>
        <div class="card-body">
            <form method="get">
                <div class="row g-3 align-items-end">
                    <!-- Lọc 1: Tìm kiếm (Search) -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Tìm theo từ khóa</label>
                        <input class="form-control" type="text" name="Q" value="@Model.Q" placeholder="Tên trạm, địa chỉ, cổng..." />
                    </div>
                    <!-- Lọc 2: Trạng thái (Combo Box) -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Trạng thái</label>
                        <!-- Thêm class "select2-basic" để kích hoạt Combo Box -->
                        <select class="form-select select2-basic" name="Status" data-placeholder="Chọn trạng thái">
                            <option value="">-- Tất cả --</option>
                            <option value="ongoing" selected="@(Model.Status == "ongoing")">Đang diễn ra</option>
                            <option value="success" selected="@(Model.Status == "success")">Thành công</option>
                            <option value="cancelled" selected="@(Model.Status == "cancelled")">Đã hủy</option>
                        </select>
                    </div>
                    <!-- Lọc 3: Từ Ngày -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">Từ ngày</label>
                        <input class="form-control" type="date" name="From" value="@(Model.From?.ToString("yyyy-MM-dd"))" />
                    </div>
                    <!-- Lọc 4: Đến Ngày -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">Đến ngày</label>
                        <input class="form-control" type="date" name="To" value="@(Model.To?.ToString("yyyy-MM-dd"))" />
                    </div>
                    <!-- Nút bấm -->
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <!-- NÚT GRADIENT (từ site.css) -->
                        <button class="btn btn-gradient-primary flex-fill">
                            <i class="bi bi-search me-1"></i> Lọc
                        </button>
                        <a class="btn btn-outline-secondary" href="@Url.Page(null)" title="Reset">
                            <i class="bi bi-arrow-clockwise"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- KẾT QUẢ (DANH SÁCH CARD THAY VÌ TABLE) -->
    @if (Model.Items.Count == 0)
    {
        <!-- Trạng thái rỗng chuyên nghiệp -->
        <div class="text-center p-5 text-muted">
            <i class="bi bi-search fs-1 mb-3"></i>
            <h5 class="mb-0">Không tìm thấy lịch đặt nào.</h5>
            <p>Hãy thử thay đổi bộ lọc hoặc <a asp-page="/Map/Index">đặt lịch mới</a>.</p>
        </div>
    }
    else
    {
        @foreach (var x in Model.Items)
        {
            var status = (x.Status ?? "").ToLowerInvariant();
            var canCancel =
            string.Equals(x.Status, "ongoing", StringComparison.OrdinalIgnoreCase)
            && x.StartTime.HasValue && x.StartTime.Value > nowUtc;

            <!-- MỖI BOOKING LÀ MỘT CARD (từ site.css) -->
            <div class="card booking-card shadow-sm mb-3">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <!-- CỘT TRÁI: THÔNG TIN (8) -->
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <!-- Tên trạm và Trạng thái -->
                                <div>
                                    <h4 class="fw-bold mb-1">@x.StationName</h4>

                                    <!-- BADGE (NHÃN) TRẠNG THÁI (dùng Bootstrap 5.3) -->
                                    @if (status == "success")
                                    {
                                        <span class="badge rounded-pill bg-success-subtle text-success-emphasis">
                                            <i class="bi bi-check-circle me-1"></i> Thành công
                                        </span>
                                    }
                                    else if (status == "cancelled")
                                    {
                                        <span class="badge rounded-pill bg-danger-subtle text-danger-emphasis">
                                            <i class="bi bi-x-circle me-1"></i> Đã hủy
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">
                                            <i class="bi bi-clock me-1"></i> Đang diễn ra
                                        </span>
                                    }
                                </div>
                                <!-- Giá tiền -->
                                <span class="text-success fw-bold fs-5">@x.Price.ToString("N0") ₫/kWh</span>
                            </div>

                            <hr class="my-3">

                            <!-- Thông tin chi tiết (với icon) -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt-fill"></i>
                                        <span>@x.StationLocation</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-ev-station-fill"></i>
                                        <span>Cổng <strong>@x.PortType</strong></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <i class="bi bi-calendar-check-fill"></i>
                                        <span>@((x.StartTime?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")) ?? "-")</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-clock-fill"></i>
                                        <span>@((x.EndTime?.ToLocalTime().ToString("HH:mm")) ?? "-")</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CỘT PHẢI: NÚT BẤM (4) -->
                        <div class="col-md-4 d-flex flex-column justify-content-center align-items-stretch gap-2 border-start-md">
                            <!-- Nút Xem (Nổi bật) -->
                            <a class="btn btn-primary"
                               href="@Url.Page("/Booking/Detail", new { id = x.BookingId })">
                                <i class="bi bi-eye me-1"></i> Xem Chi tiết
                            </a>

                            @if (canCancel)
                            {
                                <!-- Nút Hủy (Mở Modal) -->
                                <button type="button" class="btn btn-outline-danger"
                                        data-bs-toggle="modal" data-bs-target="#cancelModal"
                                        data-booking-id="@x.BookingId"
                                        data-station-name="@x.StationName">
                                    <i class="bi bi-x-lg me-1"></i> Hủy Lịch
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="bi bi-x-lg me-1"></i> Hủy Lịch
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- MODAL XÁC NHẬN HỦY (Thay thế confirm()) -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <!-- SỬA: asp-route-* để giữ lại filter khi quay về -->
            <form method="post" asp-page-handler="Cancel" asp-route-Q="@Model.Q" asp-route-Status="@Model.Status" asp-route-From="@Model.From" asp-route-To="@Model.To">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> Xác nhận Hủy Lịch
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn hủy lịch đặt tại trạm:</p>
                    <p class="text-danger fw-bold" id="cancelItemName"></p>
                    <!-- Input ẩn để gửi ID booking -->
                    <input type="hidden" name="id" id="cancelBookingId" />
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                    <button type="submit" class="btn btn-danger">Đồng ý Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPT CHO MODAL VÀ SELECT2 -->
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <script>
        $(document).ready(function() {
            // 1. Kích hoạt Select2 (Combo Box)
            $('.select2-basic').select2({
                theme: "bootstrap-5",
                placeholder: "Chọn trạng thái",
                allowClear: true,
                dropdownParent: $('.card-body form') // Fix lỗi select2 trong card
            });

            // 2. Script cho Modal Hủy lịch
            var cancelModal = document.getElementById('cancelModal');
            cancelModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var bookingId = button.getAttribute('data-booking-id');
                var stationName = button.getAttribute('data-station-name');

                cancelModal.querySelector('#cancelBookingId').value = bookingId;
                cancelModal.querySelector('#cancelItemName').textContent = stationName;
            });
        });
    </script>
}