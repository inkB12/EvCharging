@page
@model EVCharging.Pages.Driver.ChargingHabitsReportModel
@{
	ViewData["Title"] = "HabbitReport";
}

<h2>Phân Tích Thói Quen Sạc Cá Nhân</h2>
<hr />

@* Choose Year *@
<form method="get" class="mb-4">
	<div class="row">
		<div class="col-md-3">
			<label asp-for="SelectedYear" class="form-label">Chọn Năm:</label>
			<select asp-for="SelectedYear" class="form-select">
				@{
					int currentYear = DateTime.Now.Year;
					for (int y = currentYear; y >= currentYear - 5; y--)
					{
						<option value="@y">@y</option>
					}
				}
			</select>
		</div>
		<div class="col-md-3 d-flex align-items-end">
			<button type="submit" class="btn btn-primary">Xem Báo Cáo</button>
		</div>
	</div>
</form>

@* Total Sessions *@
@if (Model.TotalSessionsYear > 0)
{
	<div class="row mb-4">
		<div class="col-md-4">
			<div class="card text-white bg-primary mb-3">
				<div class="card-header">Tổng Phiên Sạc Trong Năm @Model.SelectedYear</div>
				<div class="card-body">
					<h4 class="card-title">@Model.TotalSessionsYear.ToString("N0")</h4>
				</div>
			</div>
		</div>
	</div>
}
else
{
	<div class="alert alert-warning" role="alert">
		Không có dữ liệu thói quen sạc trong năm @Model.SelectedYear.
	</div>
}

@* Habit Reports *@
<div class="row">
	<div class="col-md-6">
		<div class="card shadow-sm mb-4">
			<div class="card-header">Địa Điểm Sạc Thường Xuyên</div>
			<div class="card-body">
				<canvas id="locationChart" style="height: 350px;"></canvas>
			</div>
		</div>
	</div>

	<div class="col-md-6">
		<div class="card shadow-sm mb-4">
			<div class="card-header">Khung Giờ Sạc Phổ Biến</div>
			<div class="card-body">
				<canvas id="timeChart" style="height: 350px;"></canvas>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
	<script>
		// --- 1. Thống kê Địa điểm ---
		var locationData = @Html.Raw(Json.Serialize(Model.LocationHabits));
		var locationLabels = locationData.map(item => item.stationName);
		var locationCounts = locationData.map(item => item.sessionCount);

		new Chart(document.getElementById('locationChart'), {
			type: 'doughnut', // Biểu đồ tròn
			data: {
				labels: locationLabels,
				datasets: [{
					label: 'Số Lần Sạc',
					data: locationCounts,
					// Tự động tạo màu sắc ngẫu nhiên
					backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: {
						position: 'right',
					}
				}
			}
		});

		// --- 2. Thống kê Khung giờ ---
		var timeData = @Html.Raw(Json.Serialize(Model.TimeHabits));
		var timeLabels = timeData.map(item => item.timeRangeLabel);
		var timeCounts = timeData.map(item => item.sessionCount);

		new Chart(document.getElementById('timeChart'), {
			type: 'bar',
			data: {
				labels: timeLabels, // Ví dụ: 00:00 - 01:00, ... 23:00 - 00:00
				datasets: [{
					label: 'Số Lần Sạc',
					data: timeCounts,
					backgroundColor: 'rgba(78, 115, 223, 0.8)',
					borderColor: 'rgba(78, 115, 223, 1)',
					borderWidth: 1
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				scales: {
					y: {
						beginAtZero: true,
						title: { display: true, text: 'Số Phiên Sạc' }
					}
				}
			}
		});
	</script>
}