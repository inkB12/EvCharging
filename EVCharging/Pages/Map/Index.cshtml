@page
@model EVCharging.Pages.Map.IndexModel
@{
    ViewData["Title"] = "Tìm trạm sạc";
    Layout = "/Pages/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
<style>
    /* === CẤU TRÚC LAYOUT MỚI === */

    /* Chúng ta không dùng .wrap cũ nữa,
          thay vào đó dùng container-fluid và row của Bootstrap
          để kiểm soát layout tốt hơn.
        */
    .map-page-container {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }

    /* === CỘT BÊN PHẢI (PANEL) === */
    .panel-container {
        /* Chúng ta sẽ cho panel bên phải "dính" lại (sticky)
               khi cuộn trang, tạo cảm giác chuyên nghiệp.
               "100px" là khoảng cách từ top, chừa chỗ cho navbar của bạn.
            */
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 120px); /* Chiều cao tối đa, chừa navbar và lề */
        overflow-y: auto; /* Tự động có thanh cuộn nếu nội dung dài */
        padding-right: 10px; /* Thêm lề cho thanh cuộn */
    }

    /* === BOX HƯỚNG DẪN MỚI === */
    .guide-box {
        background-color: #f8f9fa; /* Màu nền xám rất nhạt */
        border: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,.04);
    }

        .guide-box .card-body {
            padding: 1.25rem 1.5rem;
        }

        .guide-box .guide-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

            .guide-box .guide-step:last-child {
                margin-bottom: 0;
            }

        .guide-box .step-number {
            /* Vòng tròn đánh số */
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #e7f0ff; /* Nền xanh nhạt (giống _Layout) */
            color: #0d6efd; /* Chữ xanh primary */
            font-weight: 700;
            font-size: 0.9rem;
        }

        .guide-box .step-content .title {
            font-weight: 600;
            color: #212529;
        }

        .guide-box .step-content .desc {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 0;
        }


    /* === THANH CÔNG CỤ (TRÁI) === */
    .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        background: #ffffff;
        margin-bottom: 1rem; /* Đổi từ 10px thành 1rem */
        box-shadow: 0 4px 12px rgba(0,0,0,.04);
    }

        .toolbar input {
            /* Dùng class form-control của Bootstrap */
            flex-grow: 1; /* Cho ô input chiếm hết chỗ */
        }

    /* === BẢN ĐỒ (TRÁI) === */
    #map {
        /* Chiều cao chuyên nghiệp hơn, 650px.
               Bạn có thể chỉnh thành 70vh (70% chiều cao màn hình) nếu muốn.
            */
        height: 650px;
        border-radius: 14px;
        box-shadow: 0 8px 28px rgba(0,0,0,.08);
        border: 1px solid #dee2e6;
    }

    /* === PANEL ĐẶT LỊCH (PHẢI) === */
    .panel {
        display: grid;
        gap: 1rem; /* Tăng khoảng cách */
        padding: 1.5rem; /* Tăng padding */
        border: 1px solid #dee2e6;
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 4px 12px rgba(0,0,0,.04);
    }

        .panel h4 {
            margin-bottom: 0; /* Bootstrap đã lo việc này */
        }

    /* Làm cho các nút "Kiểm tra", "Đặt lịch"
           và các ô input/select đẹp hơn trên di động.
        */
    .form-actions-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    #statusMsg {
        flex-basis: 100%; /* Cho status message luôn xuống hàng */
        margin-top: 5px;
    }

    .muted {
        color: #6c757d; /* Dùng màu muted của Bootstrap */
        font-size: 0.85rem; /* Chỉnh lại font size */
    }

    /* === ICON TRẠM SẠC (Giữ nguyên) === */
    .ev-marker {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: radial-gradient(circle at 35% 35%,#b6ffb6,#39c65a 60%,#2aa84a);
        border: 2px solid #fff;
        box-shadow: 0 0 0 1px rgba(0,0,0,.15),0 8px 14px rgba(0,0,0,.2);
        display: grid;
        place-items: center;
        transform: translate(-50%,-50%);
        position: relative
    }

        .ev-marker span {
            font-size: 16px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,.35)
        }
</style>

<div class="container-fluid map-page-container">

    <h2 class="mb-4">@ViewData["Title"]</h2>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="toolbar">
                <i class="bi bi-search me-1 text-muted"></i>
                <input id="q" type="text" class="form-control" placeholder="Tìm trạm theo tên hoặc địa chỉ..." />
                <button id="fitAllBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-arrows-fullscreen me-1"></i> Fit All
                </button>
            </div>

            <div id="map"></div>
        </div>

        <div class="col-lg-4">

            <div class="panel-container">

                <div class="card guide-box mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-info-circle-fill me-2 text-primary"></i>
                            Hướng dẫn đặt lịch
                        </h5>
                        <div class="guide-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <div class="title">Tìm trạm sạc</div>
                                <p class="desc">Sử dụng ô tìm kiếm hoặc nhấn vào trạm ⚡ trên bản đồ.</p>
                            </div>
                        </div>
                        <div class="guide-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <div class="title">Chọn thông tin</div>
                                <p class="desc">Điền loại cổng, ngày và khung giờ bạn muốn sạc.</p>
                            </div>
                        </div>
                        <div class="guide-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <div class="title">Hoàn tất đặt lịch</div>
                                <p class="desc">Nhấn "Kiểm tra" và sau đó "Đặt lịch" để xác nhận.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h4><i class="bi bi-calendar-plus me-2"></i> Đặt lịch sạc</h4>

                    <div class="row g-3">
                        <div class="col-12">
                            <select id="stationSelect" class="form-select form-select-lg">
                                <option value="">-- 1. Chọn trạm sạc --</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <select id="portTypeSelect" class="form-select" disabled>
                                <option value="">-- 2. Chọn loại cổng --</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <input id="dateInput" type="date" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <select id="slotSelect" class="form-select">
                            </select>
                        </div>
                    </div>

                    <div class="form-actions-row">
                        <button id="checkBtn" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i> Kiểm tra
                        </button>
                        <button id="bookBtn" class="btn btn-success" disabled>
                            <i class="bi bi-lightning-charge-fill me-1"></i> Đặt lịch
                        </button>
                        <span id="statusMsg" class="muted"></span>
                    </div>

                    <div class="muted">
                        Lưu ý: Mỗi slot là 1 tiếng (8:00–9:00, ...).
                    </div>
                </div>

            </div>
        </div>
    </div>
</div> <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
    
    // Thiết lập kết nối SignalR
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/stationHub")
        .withAutomaticReconnect()
        .build();

    // Bắt đầu kết nối
    connection.start().then(() => {
        console.log("SignalR Connected to StationHub.");
    }).catch(err => {
        console.error("SignalR Connection Error: ", err.toString());
    });

        // Xử lý sự kiện khi có trạm sạc mới được tạo
    connection.on("StationCreated", function (stationDto) {
        console.log("StationCreated Signal Received:", stationDto);

        // 1. CHUYỂN DỮ LIỆU ĐẾN ĐỊNH DẠNG CŨ CỦA JAVASCRIPT
        const newStation = {
            id: stationDto.id,
            name: stationDto.name,
            location: stationDto.location,
            longtitude: stationDto.longtitude,
            latitude: stationDto.latitude,
        };

        // 2. CẬP NHẬT MẢNG DỮ LIỆU GỐC
        stationsRaw.push(newStation);

        // 3. CẬP NHẬT BẢN ĐỒ VÀ DROPDOWN
        // Thêm Marker vào LayerGroup
        const m = L.marker([newStation.latitude, newStation.longtitude], {icon: evIcon})
            .bindPopup(`<b>${escapeHtml(newStation.name)}</b><br/><span class="muted">${escapeHtml(newStation.location||'')}</span>`);
        m.on('click', ()=>{
            stationSelect.value = String(newStation.id);
            loadPortTypes(newStation.id);
        });
        m.addTo(layerGroup);

        // Thêm Option vào Dropdown
        const newOption = document.createElement('option');
        newOption.value = newStation.id;
        newOption.textContent = `${escapeHtml(newStation.name)} (${escapeHtml(newStation.location||'')})`;
        stationSelect.appendChild(newOption);

        // Hiển thị thông báo nhỏ trên giao diện
        statusMsg.textContent = `✅ Trạm sạc mới đã được thêm: ${newStation.name}`;
        setTimeout(() => { statusMsg.textContent = ''; }, 5000);
    });


    /*
      TOÀN BỘ JAVASCRIPT CỦA BẠN ĐƯỢC GIỮ NGUYÊN
      Vì chúng ta chỉ thay đổi HTML/CSS,
      và vẫn giữ nguyên tất cả 'id' của các element,
      nên code logic của bạn sẽ chạy bình thường mà không cần sửa.
    */
    const map = L.map('map', { zoomControl: true }).setView([16.0471, 108.2068], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
    const evIcon = L.divIcon({className:'', html:'<div class="ev-marker"><span>⚡</span></div>', iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-14]});
    const layerGroup = L.layerGroup().addTo(map);

    const qInput = document.getElementById('q');
    const stationSelect = document.getElementById('stationSelect');
    const portTypeSelect = document.getElementById('portTypeSelect');
    const dateInput = document.getElementById('dateInput');
    const slotSelect = document.getElementById('slotSelect');
    const checkBtn = document.getElementById('checkBtn');
    const bookBtn = document.getElementById('bookBtn');
    const statusMsg = document.getElementById('statusMsg');

    const slots = [];
    for (let h=8; h<22; h++){ slots.push({ label: `${h}:00 - ${h+1}:00`, start:h, end:h+1 }); }
    slotSelect.innerHTML = slots.map(s=>`<option value="${s.start}">${s.label}</option>`).join('');

    let stationsRaw = [];
    let filtered = [];

    async function loadStations(){
        const res = await fetch('/Map/Api?handler=Stations');
        stationsRaw = await res.json(); // [{id,name,location,long,lat,status}]
        filtered = stationsRaw;
        renderMarkers(filtered);
        renderStationOptions(filtered);
        fitAll(filtered);
    }
    function renderMarkers(list){
        layerGroup.clearLayers();
        list.forEach(s=>{
            const m = L.marker([s.latitude, s.longtitude], {icon: evIcon})
                .bindPopup(`<b>${escapeHtml(s.name)}</b><br/><span class="muted">${escapeHtml(s.location||'')}</span>`);
            m.on('click', ()=>{
                stationSelect.value = String(s.id);
                loadPortTypes(s.id);
            });
            m.addTo(layerGroup);
        })
    }
    function renderStationOptions(list){
        stationSelect.innerHTML = `<option value="">-- 1. Chọn trạm sạc --</option>`+
            list.map(s=>`<option value="${s.id}">${escapeHtml(s.name)} (${escapeHtml(s.location||'')})</option>`).join('');
    }
    function fitAll(list){
        if(!list.length) return;
        const b = L.latLngBounds(list.map(s=>[s.latitude,s.longtitude]));
        map.fitBounds(b, {padding:[30,30]});
    }
    qInput.addEventListener('input', ()=>{
        const q = qInput.value.trim().toLowerCase();
        filtered = !q ? stationsRaw : stationsRaw.filter(s =>
            (s.name||'').toLowerCase().includes(q) || (s.location||'').toLowerCase().includes(q));
        renderMarkers(filtered);
        renderStationOptions(filtered);
    });
    document.getElementById('fitAllBtn').addEventListener('click', ()=>fitAll(filtered));

        stationSelect.addEventListener('change', async ()=>{
      const sid = stationSelect.value;
      portTypeSelect.disabled = !sid;
      if (sid) await loadPortTypes(sid);
    });

    async function loadPortTypes(stationId){
      portTypeSelect.disabled = true;
      portTypeSelect.innerHTML = `<option value="">Đang tải...</option>`;
      try {
        const res = await fetch(`/Map/Api?handler=PortTypes&stationId=${stationId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const types = await res.json(); // ["AC","CCS","CHAdeMO"]

        if (!Array.isArray(types) || types.length === 0) {
          portTypeSelect.innerHTML = `<option value="">(Không có cổng khả dụng)</option>`;
          portTypeSelect.disabled = true;
          return;
        }

        portTypeSelect.innerHTML = `<option value="">-- 2. Chọn loại cổng --</option>` +
          types.map(t => `<option value="${t}">${t}</option>`).join('');
        portTypeSelect.disabled = false;
      } catch (err) {
        console.error('Load PortTypes error:', err);
        portTypeSelect.innerHTML = `<option value="">Lỗi tải Port Types</option>`;
        portTypeSelect.disabled = true;
      }
    }

    checkBtn.addEventListener('click', async ()=>{
        statusMsg.textContent = '';
        bookBtn.disabled = true;

        const stationId = stationSelect.value;
        const portType = portTypeSelect.value;
        const date = dateInput.value;
        const startHour = parseInt(slotSelect.value,10);

        if (!stationId || !portType || !date) {
            statusMsg.textContent = 'Vui lòng chọn đầy đủ Station, Port Type và Ngày.';
            return;
        }

        const res = await fetch(`/Map/Api?handler=Check&stationId=${stationId}&portType=${encodeURIComponent(portType)}&date=${date}&startHour=${startHour}`);
        const data = await res.json(); // {ok, msg, candidatePointId}
        statusMsg.textContent = data.msg || '';
        bookBtn.disabled = !data.ok;
        bookBtn.dataset.pointId = data.candidatePointId || '';
    });

        bookBtn.addEventListener('click', async () => {
      const stationId = stationSelect.value;
      const portType  = portTypeSelect.value;
      const date      = dateInput.value;
      const startHour = parseInt(slotSelect.value, 10);
      const candidatePointId = bookBtn.dataset.pointId;

      if (!candidatePointId) return;

      const payload = {
        stationId: +stationId,
        portType,
        date,
        startHour: +startHour,
        pointId: +candidatePointId
      };

      try {
        const res  = await fetch('/Map/Api?handler=Book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json(); // { ok, msg, bookingId, sessionId }

        statusMsg.textContent = data.msg || '';
        if (data.ok) {
          // 👉 Redirect sang trang Booking
          window.location.href = '/Booking';
          // (Nếu muốn mang theo bookingId: window.location.href = `/Booking?new=${data.bookingId}`;)
        } else {
          bookBtn.disabled = false;
        }
      } catch (e) {
        console.error(e);
        statusMsg.textContent = 'Có lỗi khi tạo lịch.';
        bookBtn.disabled = false;
      }
    });


    function escapeHtml(str){return String(str??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');}

    loadStations();
</script>